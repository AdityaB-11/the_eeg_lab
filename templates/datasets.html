{% extends "base.html" %}

{% block title %}Datasets - EEG Lab{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar">
            <div class="p-3">
                <h5>Dataset Filters</h5>
                <div class="mb-3">
                    <label class="form-label">File Type</label>
                    <select class="form-select" id="fileTypeFilter">
                        <option value="">All Types</option>
                        <option value=".edf">EDF</option>
                        <option value=".csv">CSV</option>
                        <option value=".mat">MAT</option>
                        <option value=".h5">HDF5</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Size Range</label>
                    <select class="form-select" id="sizeFilter">
                        <option value="">All Sizes</option>
                        <option value="small">1GB - 10GB</option>
                        <option value="medium">10GB - 50GB</option>
                        <option value="large">50GB - 100GB</option>
                        <option value="xlarge">&gt; 100GB</option>
                    </select>
                </div>
                <button class="btn btn-success w-100 mb-3" onclick="uploadNewDataset()">
                    <i class="fas fa-upload"></i> Upload Dataset
                </button>
                <button class="btn btn-outline-primary w-100" onclick="importFromUrl()">
                    <i class="fas fa-link"></i> Import from URL
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Data Repository</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshDatasets()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                    <button class="btn btn-outline-success" onclick="bulkDownload()">
                        <i class="fas fa-download"></i> Bulk Download
                    </button>
                </div>
            </div>

            <!-- Storage Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-database fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-0">{{ datasets|length }}</h5>
                                    <small>Total Datasets</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-hdd fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-0" id="totalSize">0 GB</h5>
                                    <small>Total Size</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-line fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-0">85%</h5>
                                    <small>Storage Used</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-0">{{ datasets|length }}</h5>
                                    <small>Recent Uploads</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datasets Grid -->
            <div class="row">
                {% for dataset in datasets %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card dataset-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ dataset[1] }}</h6>
                            <span class="badge bg-success">
                                {{ (dataset[3] / 1024 / 1024)|round(1) if dataset[3] else 0 }} MB
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="fas fa-file-alt text-muted me-2"></i>
                                <small class="text-muted">{{ dataset[2].split('/')[-1].split('.')[-1].upper() if dataset[2] else 'Unknown' }} File</small>
                            </div>
                            
                            {% if dataset[4] %}
                            <p class="card-text text-muted small">{{ dataset[4][:100] }}{% if dataset[4]|length > 100 %}...{% endif %}</p>
                            {% endif %}
                            
                            <div class="mb-2">
                                <small class="text-muted">Uploaded:</small>
                                <small>{{ dataset[5][:10] if dataset[5] else 'Unknown' }}</small>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">Path:</small>
                                <code class="small">{{ dataset[2] if dataset[2] else 'N/A' }}</code>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-primary" onclick="previewDataset({{ dataset[0] }})">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-success" onclick="downloadDataset({{ dataset[0] }})">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="btn btn-sm btn-info" onclick="analyzeDataset({{ dataset[0] }})">
                                    <i class="fas fa-chart-bar"></i> Analyze
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not datasets %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-database fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No Datasets Found</h4>
                        <p class="text-muted">Upload your first EEG dataset to get started with analysis.</p>
                        <button class="btn btn-success" onclick="uploadNewDataset()">
                            <i class="fas fa-upload"></i> Upload First Dataset
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Dataset Modal -->
<div class="modal fade" id="uploadDatasetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload New Dataset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadDatasetForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="datasetFile" class="form-label">Select Dataset File</label>
                        <input type="file" class="form-control" id="datasetFile" 
                               accept=".csv,.edf,.mat,.h5,.hdf5,.fif,.set" required>
                        <div class="form-text">
                            Supported formats: CSV, EDF, MAT, HDF5, FIF, SET (max 500MB)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="datasetName" class="form-label">Dataset Name (Optional)</label>
                        <input type="text" class="form-control" id="datasetName" 
                               placeholder="Will use filename if not provided">
                    </div>
                    <div class="mb-3">
                        <label for="datasetDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="datasetDescription" rows="4" 
                                  placeholder="Describe the dataset: source, participants, experimental conditions, etc."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dataset Metadata</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" id="datasetSource" 
                                       placeholder="Data source (e.g., CHB-MIT)">
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control mb-2" id="datasetSubjects" 
                                       placeholder="Number of subjects">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" class="form-control mb-2" id="datasetChannels" 
                                       placeholder="Number of EEG channels">
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control mb-2" id="datasetSampleRate" 
                                       placeholder="Sample rate (Hz)">
                            </div>
                        </div>
                    </div>
                </form>
                <div class="progress d-none" id="uploadProgress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitUploadDataset()">
                    <i class="fas fa-upload"></i> Upload Dataset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Preview Modal -->
<div class="modal fade" id="datasetPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dataset Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetPreviewContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="openInNotebook()">
                    <i class="fas fa-book"></i> Open in Notebook
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Import from URL Modal -->
<div class="modal fade" id="importUrlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Dataset from URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importUrlForm">
                    <div class="mb-3">
                        <label for="datasetUrl" class="form-label">Dataset URL</label>
                        <input type="url" class="form-control" id="datasetUrl" 
                               placeholder="https://example.com/dataset.csv" required>
                    </div>
                    <div class="mb-3">
                        <label for="urlDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="urlDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitImportUrl()">
                    <i class="fas fa-download"></i> Import Dataset
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function uploadNewDataset() {
        const modal = new bootstrap.Modal(document.getElementById('uploadDatasetModal'));
        modal.show();
    }

    function submitUploadDataset() {
        const fileInput = document.getElementById('datasetFile');
        const description = document.getElementById('datasetDescription').value;
        const name = document.getElementById('datasetName').value;
        
        if (!fileInput.files[0]) {
            alert('Please select a file');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('description', description);
        if (name) formData.append('name', name);
        
        // Show progress bar
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = progressDiv.querySelector('.progress-bar');
        progressDiv.classList.remove('d-none');
        
        fetch('/upload_dataset', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            progressDiv.classList.add('d-none');
            if (data.success) {
                alert('Dataset uploaded successfully!');
                bootstrap.Modal.getInstance(document.getElementById('uploadDatasetModal')).hide();
                location.reload();
            } else {
                alert('Error uploading dataset: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            progressDiv.classList.add('d-none');
            alert('Error uploading dataset: ' + error.message);
        });
    }

    function previewDataset(datasetId) {
        // Mock preview content - in real implementation, this would fetch actual data
        const previewContent = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6>Dataset Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Format:</strong></td><td>EDF</td></tr>
                        <tr><td><strong>Channels:</strong></td><td>23</td></tr>
                        <tr><td><strong>Sample Rate:</strong></td><td>256 Hz</td></tr>
                        <tr><td><strong>Duration:</strong></td><td>1 hour 23 minutes</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Data Preview</h6>
                    <canvas id="previewChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <h6>Sample Data</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>FP1</th>
                                    <th>FP2</th>
                                    <th>F3</th>
                                    <th>F4</th>
                                    <th>C3</th>
                                    <th>C4</th>
                                    <th>...</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>0.000</td><td>-12.5</td><td>8.3</td><td>15.2</td><td>-3.7</td><td>22.1</td><td>-8.9</td><td>...</td></tr>
                                <tr><td>0.004</td><td>-11.2</td><td>9.1</td><td>14.8</td><td>-4.2</td><td>21.8</td><td>-9.3</td><td>...</td></tr>
                                <tr><td>0.008</td><td>-10.9</td><td>9.8</td><td>14.3</td><td>-4.8</td><td>21.4</td><td>-9.8</td><td>...</td></tr>
                                <tr><td>0.012</td><td>-10.1</td><td>10.2</td><td>13.9</td><td>-5.1</td><td>20.9</td><td>-10.2</td><td>...</td></tr>
                                <tr><td>0.016</td><td>-9.8</td><td>10.6</td><td>13.4</td><td>-5.5</td><td>20.5</td><td>-10.7</td><td>...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('datasetPreviewContent').innerHTML = previewContent;
        const modal = new bootstrap.Modal(document.getElementById('datasetPreviewModal'));
        modal.show();
        
        // Create a simple chart after modal is shown
        setTimeout(() => {
            const ctx = document.getElementById('previewChart');
            if (ctx) {
                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 100}, (_, i) => i),
                        datasets: [{
                            label: 'EEG Signal Sample',
                            data: Array.from({length: 100}, () => Math.random() * 50 - 25),
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { 
                                title: { display: true, text: 'Amplitude (μV)' }
                            },
                            x: { 
                                title: { display: true, text: 'Time (samples)' }
                            }
                        }
                    }
                });
            }
        }, 500);
    }

    function downloadDataset(datasetId) {
        alert(`Downloading dataset ${datasetId}... (Feature to be implemented)`);
    }

    function analyzeDataset(datasetId) {
        alert(`Analyzing dataset ${datasetId}... (Feature to be implemented)`);
    }

    function importFromUrl() {
        const modal = new bootstrap.Modal(document.getElementById('importUrlModal'));
        modal.show();
    }

    function submitImportUrl() {
        const url = document.getElementById('datasetUrl').value;
        const description = document.getElementById('urlDescription').value;
        
        if (!url) {
            alert('Please enter a URL');
            return;
        }
        
        // TODO: Implement URL import functionality
        alert('URL import feature to be implemented');
    }

    function openInNotebook() {
        // Create a new notebook for dataset analysis
        const notebookName = `dataset_analysis_${Date.now()}.ipynb`;
        
        fetch('/create_notebook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: notebookName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/notebooks`;
            }
        });
    }

    function refreshDatasets() {
        location.reload();
    }

    function bulkDownload() {
        alert('Bulk download feature to be implemented');
    }

    // Calculate total size on page load
    document.addEventListener('DOMContentLoaded', function() {
        const sizes = [{% for dataset in datasets %}{{ dataset[3] or 0 }}{% if not loop.last %},{% endif %}{% endfor %}];
        const totalBytes = sizes.reduce((sum, size) => sum + size, 0);
        const totalGB = (totalBytes / 1024 / 1024 / 1024).toFixed(2);
        document.getElementById('totalSize').textContent = totalGB + ' GB';
    });
</script>
{% endblock %}
